const SPREADSHEET_ID = '1-EnWGBXyeWoVOxRRTSvguzgxdZ-KVCbjL8gitpGglrE'; // Pastikan ID Benar

function getDb() { return SpreadsheetApp.openById(SPREADSHEET_ID); }
function responseJSON(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }

// FUNGSI AMAN (Mencegah Error)
function getSafeData(sheetName, numCols) {
  try {
    const ss = getDb();
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return [];
    if (sheet.getLastRow() < 2) return [];
    return sheet.getRange(2, 1, sheet.getLastRow() - 1, numCols).getValues();
  } catch (e) { return []; }
}

// --- API GET (BACA DATA) ---
function doGet(e) {
  const op = e.parameter.action;
  
  if (op === 'getPublicData') {
    const config = {};
    const dataConfig = getSafeData('Config', 2);
    dataConfig.forEach(r => { if(r[0]) config[r[0]] = r[1]; });

    // Data Guru (Public)
    const dataGuru = getSafeData('Guru', 8).map(r => ({ nama: r[3], nip: r[4], mapel: r[5], foto: r[7] }));
    
    // Data Siswa
    const dataSiswa = getSafeData('Siswa', 3);
    let l=0, p=0; dataSiswa.forEach(r => { l+=Number(r[1]||0); p+=Number(r[2]||0); });

    // Data Galeri (Foto, Video, Musik)
    const dataGaleri = getSafeData('Galeri', 3).map(r => ({ tipe: r[0], judul: r[1], link: r[2] }));

    // Berita & DL
    const berita = getSafeData('Berita', 4).reverse().slice(0, 3);
    const download = getSafeData('Downloads', 3);

    return responseJSON({
      status: 'success', config: config,
      stats: { siswa: l+p, guru: dataGuru.length, kelas: dataSiswa.length },
      guruList: dataGuru, siswaDetail: dataSiswa,
      galeri: dataGaleri, // Data Multimedia
      berita: berita, downloads: download
    });
  }
  return responseJSON({status:'error'});
}

// --- API POST (SIMPAN DATA) ---
function doPost(e) {
  const params = JSON.parse(e.postData.contents);
  const op = params.action;
  const db = getDb();

  // LOGIN
  if (op === 'login') {
    let adminPass = 'admin123';
    const conf = getSafeData('Config', 2);
    conf.forEach(r => { if(r[0]==='AdminPassword') adminPass = String(r[1]); });
    
    if(params.user === 'admin' && String(params.pass) === adminPass) return responseJSON({ status: 'success', role: 'admin' });
    
    // Cek Guru
    const guru = getSafeData('Guru', 8);
    for(let g of guru) {
      if(g[1] == params.user && g[2] == params.pass) return responseJSON({ status: 'success', role: 'guru', data: {nama:g[3]} });
    }
    return responseJSON({ status: 'error', message: 'Gagal Login' });
  }

  // SIMPAN CONFIG (Termasuk Sosmed)
  if (op === 'saveConfig') {
    const sheet = db.getSheetByName('Config');
    const data = sheet.getDataRange().getValues();
    for (const [key, val] of Object.entries(params.data)) {
        let found = false;
        for(let i=0; i<data.length; i++) {
            if(data[i][0] === key) { sheet.getRange(i+1, 2).setValue(val); found = true; break; }
        }
        if(!found) sheet.appendRow([key, val]);
    }
    return responseJSON({ status: 'success' });
  }

  // SIMPAN MULTIMEDIA (GALERI)
  if (op === 'saveGaleri') {
    db.getSheetByName('Galeri').appendRow([params.data.tipe, params.data.judul, params.data.link]);
    return responseJSON({ status: 'success' });
  }
  
  if (op === 'deleteGaleri') {
    // Hapus berdasarkan Link (Unik)
    const sheet = db.getSheetByName('Galeri');
    const data = sheet.getDataRange().getValues();
    for(let i=1; i<data.length; i++) {
        if(data[i][2] == params.link) { sheet.deleteRow(i+1); return responseJSON({ status: 'success' }); }
    }
  }

  // FITUR LAIN (Guru, Siswa, SPMB, dll - Standar)
  if (op === 'submitSPMB') {
      db.getSheetByName('PPDB').appendRow([new Date(), params.data.nama, params.data.nik, params.data.ttl, params.data.asal, params.data.ortu, params.data.hp, 'Menunggu']);
      return responseJSON({ status: 'success' });
  }

  return responseJSON({ status: 'success' });
}